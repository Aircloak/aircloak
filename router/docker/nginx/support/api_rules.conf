client_max_body_size 4G;

error_page 500 502 504 /500.html;

# The idle timeout for a proxied request. If no data arrives in this period, the connection is closed.
proxy_read_timeout 150s;

error_page 503 @maintenance;
location @maintenance {
  rewrite ^(.*)$ /maintenance.json break;
}

location / {
  if ($key_type != "web_api") {
    return 401; # invalid web_api certificate supplied
  }
  if ($analyst_token = "") {
    return 401; # missing analyst token from the key
  }

  proxy_set_header  analyst-token $analyst_token;

  # Note: all requests to this location are redirected to frontend /api
  include /etc/nginx/support/proxy_headers.conf;
  proxy_pass http://frontend/api/;
}

location ~* ^/tasks/(?<task_token>\w*)/results {
  if ($key_type != "web_api") {
    return 401; # invalid web_api certificate supplied
  }
  if ($analyst_token = "") {
    return 401; # missing analyst token from the key
  }

  proxy_set_header  analyst-token $analyst_token;

  # Note: all requests to this location are redirected to backend /backend/api
  include /etc/nginx/support/proxy_headers.conf;
  proxy_pass http://backend/backend/api/tasks/$task_token/results?$is_args$args;
}