<div class="container-with-sidebar-narrow">
  <header class="page-header">
    <ol class="breadcrumb bg-white">
      <li class="breadcrumb-item"><%= link "Admin", to: "/admin", class: "text-muted" %></li>
    </ol>
    <button type="button" class="btn btn-primary d-block d-lg-none float-right" data-toggle="collapse"
        data-target="#sidebar" aria-expanded="false">
      <i class="fas fa-list"></i> Filters
    </button>
    <h1>Audit Log</h1>
  </header>


  <div class="px-0">

    <%= for {day, audit_logs} <- @audit_logs do %>
      <div class="day-header-bg">
        <time class="small font-weight-bold day-header mb-3" datetime="<%= NaiveDateTime.to_iso8601(day) %>">
          <%= format_date_header(day) %>
        </time>
      <%= for audit_log <- audit_logs do %>
        <%= render_audit_log(%{
          id: audit_log.id,
          event: audit_log.event,
          user_name: audit_log.user_name,
          timestamp: audit_log.max_date,
          socket: @socket,
          user_id: audit_log.user_id,
          metadata: audit_log.metadata,
          query_params: @query_params}) %>
        <%= if @expanded[{audit_log.event, audit_log.user_id, audit_log.max_date}] do %>
          <div id="audit-log-children-<%= audit_log.id%>" class="mb-3 border-left pl-3 ml-2 position-relative nested" phx-update="append">
          <%= for child_log <- (@expanded_logs[{audit_log.event, audit_log.user_id, audit_log.max_date}] || []) do %>
            <%= render_audit_log(%{
              id: child_log.id,
              event: child_log.event,
              user_name: child_log.user.name,
              timestamp: child_log.inserted_at,
              socket: @socket,
              user_id: child_log.user.id,
              metadata: child_log.metadata,
              query_params: @query_params}) %>
          <% end %>
            <button class="btn collapse-button" style="bottom: 10px" phx-click="collapse_section" phx-value-event="<%= audit_log.event %>" phx-value-user="<%= audit_log.user_id %>" phx-value-to="<%=audit_log.max_date%>"><span class="small text-muted">Collapse</span></button>
          </div>
        <% end %>
        <%= if show_pagination?(@expanded, audit_log) do %>
          <div class="collapsed timeline align-self-stretch">
            <button
              class="btn btn-link  d-block text-left mb-3"
              phx-click="expand_section"
              phx-value-event="<%= audit_log.event %>"
              phx-value-user="<%= audit_log.user_id %>"
              phx-value-from="<%= audit_log.min_date %>"
              phx-value-to="<%=audit_log.max_date%>"
              phx-value-first-event="<%= audit_log.id %>"
              phx-value-page="<%= fetch_page_data(@expanded, audit_log, :page, 0) + 1 %>">
                <i class="fas fa-arrows-alt-v"></i> Expand <%= audit_log.occurences - fetch_page_data(@expanded, audit_log, :loaded, 1) %> similar entries
            </button>
          </div>
        <% end %>

      <% end %>
      </div>
    <% end %>

    <%= if @more_pages do %>
      <button class="btn btn-outline-primary w-100 d-block mx-3 my-5" phx-click="load_next_page">Load more logs</button>
    <% end %>

  </div>
</div>



<%= render(AirWeb.Admin.SharedView, "filter_sidebar.html",
  conn: @socket,
  from: @from,
  to: @to,
  path: &admin_audit_log_index_path(@socket, :index, &1),
  users: @users,
  event_types: @event_types,
  data_sources: @data_sources,
  live?: true,
  params: @query_params)
%>
